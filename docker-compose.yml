version: '3.8'

services:
  # Application service
  app:
    build: .
    container_name: ai-use-case-app
    ports:
      - "${PORT:-3001}:3001"
    environment:
      # Application settings
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3001}
      
      # Database configuration
      DB_TYPE: ${DB_TYPE:-sqlite}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-1433}
      DB_NAME: ${DB_NAME:-ai_use_cases}
      DB_USER: ${DB_USER:-sa}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_ENCRYPT: ${DB_ENCRYPT:-true}
      DB_TRUST_SERVER_CERTIFICATE: ${DB_TRUST_SERVER_CERTIFICATE:-false}
      
      # Authentication
      AUTH_TYPE: ${AUTH_TYPE:-local}
      REACT_APP_AUTH_TYPE: ${REACT_APP_AUTH_TYPE:-local}
      REACT_APP_AZURE_AD_CLIENT_ID: ${REACT_APP_AZURE_AD_CLIENT_ID}
      REACT_APP_AZURE_AD_TENANT_ID: ${REACT_APP_AZURE_AD_TENANT_ID}
      REACT_APP_AZURE_AD_REDIRECT_URI: ${REACT_APP_AZURE_AD_REDIRECT_URI}
      REACT_APP_AZURE_AD_SCOPES: ${REACT_APP_AZURE_AD_SCOPES}
      
      # API Keys
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      # Security: JWT_SECRET must be provided via environment variable - no default
      JWT_SECRET: ${JWT_SECRET}
    
    volumes:
      - ./uploads:/app/uploads
      - ./database.sqlite:/app/database.sqlite

    # Note: No dependency on 'db' service since default is SQLite
    # If using MSSQL, start with: docker-compose --profile mssql up

    networks:
      - app-network
    
    restart: unless-stopped

  # SQL Server database (optional - only used when DB_TYPE=mssql)
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: ai-use-case-db
    ports:
      - "${DB_PORT:-1433}:1433"
    environment:
      ACCEPT_EULA: Y
      # Security: DB_PASSWORD must be provided via environment variable - no default
      MSSQL_SA_PASSWORD: ${DB_PASSWORD}
      MSSQL_PID: ${MSSQL_PID:-Developer}
    volumes:
      - mssql-data:/var/opt/mssql
    networks:
      - app-network
    restart: unless-stopped
    # Only run if using SQL Server
    profiles:
      - mssql

  # Nginx reverse proxy (optional - for production)
  nginx:
    image: nginx:alpine
    container_name: ai-use-case-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - app
    networks:
      - app-network
    restart: unless-stopped
    profiles:
      - production

networks:
  app-network:
    driver: bridge

volumes:
  mssql-data: